"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createMockClient = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _CozyClient = _interopRequireDefault(require("./CozyClient"));

var _store = require("./store");

var _cozyStackClient = require("cozy-stack-client");

var _cozyClient = require("cozy-client");

var fillQueryInsideClient = function fillQueryInsideClient(client, queryName, queryOptions) {
  var definition = queryOptions.definition,
      doctype = queryOptions.doctype,
      data = queryOptions.data,
      queryResult = (0, _objectWithoutProperties2.default)(queryOptions, ["definition", "doctype", "data"]);
  client.store.dispatch((0, _store.initQuery)(queryName, definition || (0, _cozyClient.Q)(doctype)));
  client.store.dispatch((0, _store.receiveQueryResult)(queryName, (0, _objectSpread2.default)({
    data: data.map(function (doc) {
      return (0, _cozyStackClient.normalizeDoc)(doc, doctype);
    })
  }, queryResult)));
};

var mockedQueryFromMockedRemoteData = function mockedQueryFromMockedRemoteData(remoteData) {
  return function (qdef) {
    if (!remoteData) {
      return {
        data: null
      };
    }

    if (remoteData[qdef.doctype]) {
      return {
        data: remoteData[qdef.doctype]
      };
    } else {
      return {
        data: []
      };
    }
  };
};
/**
 * Creates a client suitable for use in tests
 *
 * - client.{query,save} are mocked
 * - client.stackClient.fetchJSON is mocked
 *
 * @param  {object} options Options
 * @param  {object} options.queries Prefill queries inside the store
 * @param  {object} options.remote Mock data from the server
 * @param  {object} options.clientOptions Options passed to the client
 * @returns {CozyClient}
 */


var createMockClient = function createMockClient(_ref) {
  var queries = _ref.queries,
      remote = _ref.remote,
      clientOptions = _ref.clientOptions;
  var client = new _CozyClient.default(clientOptions || {});
  client.ensureStore();

  for (var _i = 0, _Object$entries = Object.entries(queries || {}); _i < _Object$entries.length; _i++) {
    var _Object$entries$_i = (0, _slicedToArray2.default)(_Object$entries[_i], 2),
        queryName = _Object$entries$_i[0],
        queryOptions = _Object$entries$_i[1];

    fillQueryInsideClient(client, queryName, queryOptions);
  }

  client.query = jest.fn().mockImplementation(mockedQueryFromMockedRemoteData(remote));
  client.save = jest.fn();
  client.stackClient.fetchJSON = jest.fn();
  return client;
};

exports.createMockClient = createMockClient;